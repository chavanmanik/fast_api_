<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hospital Management System</title>
  <style>
    :root {
      --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --accent:#0ea5a4; --accent-2:#06b6d4;
      --radius:12px; --shadow:0 6px 18px rgba(15,23,42,0.08);
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,#ecfeff 0%,var(--bg) 60%);color:#0f172a}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    nav{display:flex;gap:12px;align-items:center}
    a.navlink{padding:8px 12px;border-radius:10px;text-decoration:none;color:var(--muted);font-weight:600}
    a.navlink.active{background:var(--card);box-shadow:var(--shadow);color:#0f172a}
    .user-info{display:flex;align-items:center;gap:10px;color:var(--muted);font-weight:500}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(6,182,212,0.2)}
    main{max-width:1100px;margin:20px auto;padding:10px}
    .card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{color:var(--muted);font-weight:700;font-size:13px}
    input,select,textarea{width:100%;padding:9px;border:1px solid #e5e7eb;border-radius:8px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:500px}
    footer{font-size:13px;color:var(--muted);text-align:center;margin:20px 0}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">H</div>
      <div>
        <div style="font-weight:800;">HospitalSys</div>
        <div style="font-size:12px;color:var(--muted);">Manage Patients ‚Ä¢ Doctors ‚Ä¢ Appointments</div>
      </div>
    </div>
    <nav>
      <a href="#patients" class="navlink active">Patients</a>
      <a href="#doctors" class="navlink">Doctors</a>
      <a href="#appointments" class="navlink">Appointments</a>
      <div class="user-info" id="userInfo" style="display:none;">
        üëã <span id="usernameDisplay">Admin</span>
        <button class="btn ghost" onclick="logout()">Logout</button>
      </div>
    </nav>
  </header>

  <!-- Dashboard Summary -->
  <div id="summary" class="card" style="display:flex;gap:20px;justify-content:space-around;">
    <div><h3 id="totalPatients">0</h3><p>Total Patients</p></div>
    <div><h3 id="totalDoctors">0</h3><p>Total Doctors</p></div>
    <div><h3 id="totalAppointments">0</h3><p>Total Appointments</p></div>
  </div>

  <main>
    <!-- Patients -->
    <div id="patients" class="card">
      <h2>Patients</h2>
      <button class="btn ghost" onclick="openModal('patient')">+ Add Patient</button>
      <table id="patientsTable"><thead><tr><th>ID</th><th>Name</th><th>Age</th><th>Gender</th><th>Phone</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- Doctors -->
    <div id="doctors" class="card">
      <h2>Doctors</h2>
      <button class="btn ghost" onclick="openModal('doctor')">+ Add Doctor</button>
      <table id="doctorsTable"><thead><tr><th>ID</th><th>Name</th><th>Specialization</th><th>Phone</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- Appointments -->
    <div id="appointments" class="card">
      <h2>Appointments</h2>
      <button class="btn ghost" onclick="openModal('appointment')">+ Add Appointment</button>
      <table id="appointmentsTable"><thead><tr><th>ID</th><th>Patient</th><th>Doctor</th><th>Date</th><th>Reason</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </main>

  <!-- Login Modal -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal">
      <h3>Login</h3>
      <label>Username</label><input id="loginUser" />
      <label>Password</label><input id="loginPass" type="password" />
      <div style="margin-top:10px;">
        <button class="btn" onclick="submitLogin()">Login</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modalBackdrop" class="modal-backdrop"><div id="modal" class="modal"></div></div>

  <footer>Built with ‚ù§Ô∏è ‚Äî FastAPI Hospital System</footer>

  <script>
    const state = { apiBase: "http://127.0.0.1:8000", patients: [], doctors: [], appointments: [] };

    // -------------------- AUTH --------------------
    async function submitLogin() {
      const username = document.getElementById('loginUser').value;
      const password = document.getElementById('loginPass').value;
      const form = new URLSearchParams();
      form.append('username', username);
      form.append('password', password);

      const res = await fetch(state.apiBase + '/auth/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: form
      });

      const data = await res.json();
      if (data.access_token) {
        localStorage.setItem('token', data.access_token);
        localStorage.setItem('refresh', data.refresh_token);
        localStorage.setItem('username', data.username);
        document.getElementById('loginModal').style.display = 'none';
        alert('Login successful!');
        showUserInfo();
        fetchAll();
      } else {
        alert('Login failed: ' + (data.detail || 'Unknown error'));
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('refresh');
      localStorage.removeItem('username');
      alert('Logged out!');
      location.reload();
    }

    function showUserInfo() {
      const user = localStorage.getItem('username');
      if (user) {
        document.getElementById('usernameDisplay').innerText = user;
        document.getElementById('userInfo').style.display = 'flex';
      }
    }

    // -------------------- API HANDLER --------------------
    async function callApi(method, path, body) {
      try {
        let token = localStorage.getItem('token');
        const refresh = localStorage.getItem('refresh');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = 'Bearer ' + token;

        let res = await fetch(state.apiBase + path, {
          method, headers, body: body ? JSON.stringify(body) : undefined
        });

        if (res.status === 401 && refresh) {
          const newToken = await refreshAccessToken(refresh);
          if (newToken) {
            headers['Authorization'] = 'Bearer ' + newToken;
            res = await fetch(state.apiBase + path, {
              method, headers, body: body ? JSON.stringify(body) : undefined
            });
          } else {
            throw new Error('Session expired, please log in again.');
          }
        }

        if (!res.ok) throw new Error('API error ' + res.status);
        return await res.json().catch(() => null);
      } catch (err) {
        alert('API call failed: ' + err.message);
        throw err;
      }
    }

    async function refreshAccessToken(refreshToken) {
      try {
        const res = await fetch(state.apiBase + '/auth/refresh', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ refresh_token: refreshToken })
        });
        if (!res.ok) return null;
        const data = await res.json();
        if (data.access_token) {
          localStorage.setItem('token', data.access_token);
          return data.access_token;
        }
        return null;
      } catch {
        return null;
      }
    }

    // -------------------- FETCH DATA --------------------
    async function fetchAll() {
      const [pRes, dRes, aRes] = await Promise.all([
        callApi('GET', '/patients/'),
        callApi('GET', '/doctors/'),
        callApi('GET', '/appointments/')
      ]);
      state.patients = pRes || [];
      state.doctors = dRes || [];
      state.appointments = aRes || [];
      renderAll();
    }

    // -------------------- RENDER --------------------
    function renderAll() {
      renderTable('patientsTable', state.patients, ['id','name','age','gender','phone'], deletePatient);
      renderTable('doctorsTable', state.doctors, ['id','name','specialization','phone'], deleteDoctor);
      renderAppointments();
      document.getElementById('totalPatients').innerText = state.patients.length;
      document.getElementById('totalDoctors').innerText = state.doctors.length;
      document.getElementById('totalAppointments').innerText = state.appointments.length;
    }

    function renderTable(id, data, fields, delFn) {
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        fields.forEach(f => tr.innerHTML += `<td>${row[f]}</td>`);
        tr.innerHTML += `<td><button class="btn ghost" onclick="${delFn.name}(${row.id})">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderAppointments() {
      const tbody = document.querySelector('#appointmentsTable tbody');
      tbody.innerHTML = '';
      state.appointments.forEach(a => {
        const p = state.patients.find(p=>p.id===a.patient_id)?.name || a.patient_id;
        const d = state.doctors.find(d=>d.id===a.doctor_id)?.name || a.doctor_id;
        tbody.innerHTML += `<tr>
          <td>${a.id}</td><td>${p}</td><td>${d}</td><td>${a.date}</td><td>${a.reason}</td>
          <td><button class="btn ghost" onclick="deleteAppointment(${a.id})">Delete</button></td>
        </tr>`;
      });
    }

    // -------------------- CRUD --------------------
    async function deletePatient(id){ if(confirm('Delete patient?')){ await callApi('DELETE', `/patients/${id}`); fetchAll(); } }
    async function deleteDoctor(id){ if(confirm('Delete doctor?')){ await callApi('DELETE', `/doctors/${id}`); fetchAll(); } }
    async function deleteAppointment(id){ if(confirm('Delete appointment?')){ await callApi('DELETE', `/appointments/${id}`); fetchAll(); } }

    async function submitPatient(){
      const body = {name:p_name.value, age:+p_age.value, gender:p_gender.value, phone:p_phone.value};
      await callApi('POST','/patients/',body); closeModal(); fetchAll();
    }
    async function submitDoctor(){
      const body = {name:d_name.value, specialization:d_spec.value, phone:d_phone.value};
      await callApi('POST','/doctors/',body); closeModal(); fetchAll();
    }
    async function submitAppointment(){
      const body = {patient_id:+a_patient.value, doctor_id:+a_doctor.value, date:a_date.value, reason:a_reason.value};
      await callApi('POST','/appointments/',body); closeModal(); fetchAll();
    }

    // -------------------- MODALS --------------------
    function openModal(type){
      const mb=document.getElementById('modalBackdrop');const m=document.getElementById('modal');
      if(type==='patient'){
        m.innerHTML=`<h3>New Patient</h3><label>Name</label><input id='p_name'>
        <label>Age</label><input id='p_age' type='number'><label>Gender</label>
        <select id='p_gender'><option>Male</option><option>Female</option></select>
        <label>Phone</label><input id='p_phone'>
        <div style='margin-top:10px'><button class='btn' onclick='submitPatient()'>Save</button> <button class='btn ghost' onclick='closeModal()'>Cancel</button></div>`;
      } else if(type==='doctor'){
        m.innerHTML=`<h3>New Doctor</h3><label>Name</label><input id='d_name'>
        <label>Specialization</label><input id='d_spec'><label>Phone</label><input id='d_phone'>
        <div style='margin-top:10px'><button class='btn' onclick='submitDoctor()'>Save</button> <button class='btn ghost' onclick='closeModal()'>Cancel</button></div>`;
      } else {
        const pOpts=state.patients.map(p=>`<option value='${p.id}'>${p.name}</option>`).join('');
        const dOpts=state.doctors.map(d=>`<option value='${d.id}'>${d.name}</option>`).join('');
        m.innerHTML=`<h3>New Appointment</h3><label>Patient</label><select id='a_patient'>${pOpts}</select>
        <label>Doctor</label><select id='a_doctor'>${dOpts}</select><label>Date</label><input id='a_date' type='date'>
        <label>Reason</label><textarea id='a_reason'></textarea>
        <div style='margin-top:10px'><button class='btn' onclick='submitAppointment()'>Save</button> <button class='btn ghost' onclick='closeModal()'>Cancel</button></div>`;
      }
      mb.style.display='flex';
    }

    function closeModal(){document.getElementById('modalBackdrop').style.display='none';}

    // -------------------- INIT --------------------
    (function(){
      const token=localStorage.getItem('token');
      if(!token){document.getElementById('loginModal').style.display='flex';}
      else {document.getElementById('loginModal').style.display='none';showUserInfo();fetchAll();}
    })();
  </script>
</body>
</html>
